<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>구조 위치공유 시스템</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Apple SD Gothic Neo', sans-serif;
            padding: 15px;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        h1 {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        #locationDisplay {
            background-color: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        #map {
            width: 100vw !important;
            height: 100vh !important;
            border-radius: 0;
            margin: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #chatMessages {
            height: 150px;
            overflow-y: scroll;
            background: #fff;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #chatMessages div {
            margin-bottom: 8px;
            padding: 8px;
            background: #e8f4ff;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .chat-input-container {
            padding: 8px;
            background: white;
            border-top: 1px solid #eee;
            border-radius: 0 0 20px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-controls {
            display: flex;
            gap: 8px;
        }

        .control-button {
            width: 32px;
            height: 32px;
            padding: 0;
            border: none;
            background: none;
            color: #007AFF;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .control-button i {
            font-size: 1.2rem;
        }

        #chatInput {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .send-button {
            width: 32px;
            height: 32px;
            padding: 0;
            border: none;
            border-radius: 50%;
            background: #007AFF;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .send-button i {
            font-size: 1rem;
        }

        #videoContainer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
        }

        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .local-video-container {
            position: absolute;
            right: 20px;
            bottom: 20px;
            width: 150px;
            height: 200px;
        }

        #localVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .end-call-button {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ff3b30;
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .end-call-button i {
            font-size: 1.2rem;
        }

        /* 스크롤바 스타일링 */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        #videoContainer {
            display: none; /* 초기에는 숨김 */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
        }

        .video-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }

        #imagePreview {
            max-width: 200px;
            max-height: 200px;
            margin: 10px 0;
        }

        .message-image {
            max-width: 200px;
            border-radius: 8px;
            margin: 5px 0;
        }

        /* 채팅 아이콘 스타일 */
        #chatIcon {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            background: #007AFF;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
        }

        #chatIcon i {
            color: white;
            font-size: 20px;
        }

        /* 채팅창 컨테이너 스타일 */
        #chatContainer {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 25vw;
            min-width: 280px;
            max-width: 400px;
            height: 400px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            z-index: 99;
        }

        /* 반응형 디자인 */
        @media (max-width: 1200px) {
            #chatContainer {
                width: 30vw;
            }
        }

        @media (max-width: 992px) {
            #chatContainer {
                width: 40vw;
            }
        }

        @media (max-width: 768px) {
            #chatContainer {
                width: 90vw;
                height: 50vh;
            }
        }

        /* 채팅창 내부 요소들의 높이 조정 */
        .chat-header {
            padding: 10px 15px;
            background: #007AFF;
            color: white;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            margin: 0;
            font-size: 1rem;
        }

        #chatMessages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #f5f5f5;
        }

        .chat-controls {
            padding: 8px;
            background: white;
            display: flex;
            gap: 5px;
        }

        .control-button {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .chat-input-container {
            padding: 8px;
            background: white;
            border-top: 1px solid #eee;
            border-radius: 0 0 20px 20px;
            display: flex;
            gap: 5px;
        }

        #chatInput {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .chat-input-container button {
            padding: 8px 15px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .close-chat {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <h1>구조 위치공유 시스템</h1>

    <div id="map"></div>

    <div id="chatIcon" onclick="toggleChat()">
        <i class="fas fa-comments"></i>
    </div>

    <div id="chatContainer">
        <div class="chat-header">
            <h2>채팅</h2>
            <button class="close-chat" onclick="closeChat()">×</button>
        </div>
        <div id="chatMessages"></div>
        <div class="chat-input-container">
            <div class="chat-controls">
                <button class="control-button" onclick="startVideoCall()">
                    <i class="fas fa-video"></i>
                </button>
                <label class="control-button" for="imageInput">
                    <i class="fas fa-image"></i>
                </label>
                <input type="file" id="imageInput" accept="image/*" style="display: none">
            </div>
            <input type="text" id="chatInput" placeholder="메시지를 입력하세요">
            <button class="send-button" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <div id="videoContainer">
        <video id="remoteVideo" autoplay playsinline></video>
        <div class="local-video-container">
            <video id="localVideo" autoplay playsinline></video>
            <button class="end-call-button" onclick="endVideoCall()">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=0cf2a2f5a547fdb9fa41f6c2832644a8"></script>
    <script>
        // Socket.IO 연결
        const socket = io('https://structural-location-sharing-system.onrender.com', {
            transports: ['polling', 'websocket'],
            upgrade: false,
            forceNew: true,
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000
        });
        
        // PeerJS 연결
        const peer = new Peer(undefined, {
            host: 'structural-location-sharing-system.onrender.com',
            port: 443,
            path: '/peerjs',
            secure: true,
            debug: 3,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    {
                        urls: 'turn:numb.viagenie.ca',
                        username: 'webrtc@live.com',
                        credential: 'muazkh'
                    }
                ]
            }
        });

        // 연결 이벤트 핸들러 추가
        socket.on('connect', () => {
            console.log('Socket connected');
        });

        socket.on('connect_error', (error) => {
            console.log('Socket connection error:', error);
        });

        peer.on('open', (id) => {
            console.log('My peer ID is:', id);
            socket.emit('join-room', ROOM_ID, id);
        });

        // 카카오맵 초기화 및 현재 위치 추적
        let map;
        let marker;

        function initMap() {
            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(37.566826, 126.978656), // 서울시청 좌표로 초기화
                level: 3
            };
            
            map = new kakao.maps.Map(mapContainer, mapOption);

            // 지도 크기 조정 이벤트
            window.addEventListener('resize', function() {
                map.relayout();
            });

            // 현재 위치 추적 시작
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition((position) => {
                    const currentPos = new kakao.maps.LatLng(
                        position.coords.latitude, 
                        position.coords.longitude
                    );

                    // 마커가 없으면 생성, 있으면 위치 업데이트
                    if (!marker) {
                        marker = new kakao.maps.Marker({
                            position: currentPos,
                            map: map
                        });
                    } else {
                        marker.setPosition(currentPos);
                    }

                    // 지도 중심 이동
                    map.setCenter(currentPos);

                    // 위치 정보 서버로 전송
                    socket.emit('locationUpdate', {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    });
                }, 
                (error) => {
                    console.error('위치 적 오류:', error);
                }, 
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                });
            }
        }

        // 소팅 기능
        function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value;
            
            if (message.trim() !== '') {
                socket.emit('chatMessage', message);
                chatInput.value = '';
            }
        }

        socket.on('chatMessage', (message) => {
            const chatMessages = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            
            if (typeof message === 'object' && message.type === 'image') {
                const img = document.createElement('img');
                img.src = message.data;
                img.className = 'message-image';
                messageElement.appendChild(img);
            } else {
                messageElement.textContent = message;
            }
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        // 페이지 로드 시 지도 초기화
        window.onload = initMap;

        // 엔터키로 메시지 전송
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // 영상통화 관련 변수
        let currentCall;

        // 영상통화 시작
        async function startVideoCall() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = stream;
                document.getElementById('videoContainer').style.display = 'block';

                // 상대방의 호출을 받았을 때
                peer.on('call', (call) => {
                    currentCall = call;
                    call.answer(stream);
                    call.on('stream', (remoteStream) => {
                        document.getElementById('remoteVideo').srcObject = remoteStream;
                    });
                });

                // 새로운 구조대원이 참여했을 때
                socket.on('newRescuer', (peerId) => {
                    const call = peer.call(peerId, stream);
                    currentCall = call;
                    call.on('stream', (remoteStream) => {
                        document.getElementById('remoteVideo').srcObject = remoteStream;
                    });
                });

            } catch (err) {
                console.error('영상통화 시작 오류:', err);
                alert('카메라나 마이크를 사용할 수 없습니다.');
            }
        }

        // 영상통화 종료
        function endVideoCall() {
            if (currentCall) {
                currentCall.close();
            }
            if (document.getElementById('localVideo').srcObject) {
                document.getElementById('localVideo').srcObject.getTracks().forEach(track => track.stop());
            }
            document.getElementById('videoContainer').style.display = 'none';
        }

        // 사진 전송
        document.getElementById('imageInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    socket.emit('chatMessage', {
                        type: 'image',
                        data: e.target.result
                    });
                };
                reader.readAsDataURL(file);
            }
        });

        // 채팅창 토글 함수
        function toggleChat() {
            const chatIcon = document.getElementById('chatIcon');
            const chatContainer = document.getElementById('chatContainer');
            
            if (chatContainer.style.display === 'none' || chatContainer.style.display === '') {
                chatContainer.style.display = 'flex';
                chatIcon.style.display = 'none'; // 채팅창이 열리면 아이콘 숨김
            } else {
                chatContainer.style.display = 'none';
                chatIcon.style.display = 'flex'; // 채팅창이 닫히면 아이콘 표시
            }
        }

        // 채팅창 닫기 함수 추가
        function closeChat() {
            const chatIcon = document.getElementById('chatIcon');
            const chatContainer = document.getElementById('chatContainer');
            
            chatContainer.style.display = 'none';
            chatIcon.style.display = 'flex';
        }
    </script>
</body>
</html>